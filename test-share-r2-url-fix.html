<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†äº«é¡µé¢R2 URLä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        .success { border-left: 4px solid #4CAF50; background-color: #f8fff8; }
        .warning { border-left: 4px solid #FF9800; background-color: #fffbf0; }
        .error { border-left: 4px solid #f44336; background-color: #fff8f8; }
        .info { border-left: 4px solid #2196F3; background-color: #f0f8ff; }
        
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #45a049; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        
        .url-display {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            word-break: break-all;
            font-family: monospace;
        }
        .log-area {
            background-color: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #4CAF50; }
        .status-warning { background-color: #FF9800; }
        .status-error { background-color: #f44336; }
        .status-pending { background-color: #9E9E9E; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ åˆ†äº«é¡µé¢ R2 URL ä¿®å¤æµ‹è¯•</h1>
        <p>æ­¤æµ‹è¯•ç”¨äºéªŒè¯åˆ†äº«é¡µé¢æ˜¯å¦æ­£ç¡®ä½¿ç”¨ R2 æ°¸ä¹… URL è€Œä¸æ˜¯ KIE ä¸´æ—¶ URL</p>
    </div>

    <div class="container">
        <h2>ğŸ“‹ æµ‹è¯•åœºæ™¯</h2>
        
        <div class="test-section info">
            <h3>ğŸ¯ æµ‹è¯•ç›®æ ‡</h3>
            <ul>
                <li>éªŒè¯å›¾ç‰‡ç”Ÿæˆåè·å–åˆ° R2 æ°¸ä¹… URL</li>
                <li>ç¡®ä¿åˆ†äº«é¡µé¢ä½¿ç”¨ R2 URL è€Œä¸æ˜¯ä¸´æ—¶ URL</li>
                <li>æ£€æŸ¥åˆ†äº«é¡µé¢å›¾ç‰‡æ˜¾ç¤ºæ­£å¸¸</li>
                <li>éªŒè¯ URL ç±»å‹æ£€æµ‹é€»è¾‘</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª URL ç±»å‹æ£€æµ‹æµ‹è¯•</h3>
            <button onclick="testUrlDetection()">æµ‹è¯• URL ç±»å‹æ£€æµ‹</button>
            <div id="urlDetectionResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸš€ æ¨¡æ‹Ÿå›¾ç‰‡ç”Ÿæˆæµç¨‹</h3>
            <button onclick="simulateImageGeneration()" id="generateBtn">æ¨¡æ‹Ÿå›¾ç‰‡ç”Ÿæˆ</button>
            <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
            <div id="generationStatus"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“¤ åˆ†äº«åˆ›å»ºæµ‹è¯•</h3>
            <button onclick="testShareCreation()" id="shareBtn" disabled>åˆ›å»ºåˆ†äº«</button>
            <div id="shareResult"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ” åˆ†äº«é¡µé¢éªŒè¯</h3>
            <button onclick="testSharePage()" id="verifyBtn" disabled>éªŒè¯åˆ†äº«é¡µé¢</button>
            <div id="verifyResult"></div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“Š æµ‹è¯•æ—¥å¿—</h2>
        <div class="log-area" id="logArea"></div>
    </div>

    <script>
        let currentGeneratedUrl = '';
        let currentShareId = '';
        let currentShareUrl = '';

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logArea = document.getElementById('logArea');
            const color = {
                'info': '#00ff00',
                'warn': '#ffff00',
                'error': '#ff0000',
                'success': '#00ff00'
            }[type] || '#00ff00';
            
            logArea.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logArea').innerHTML = '';
        }

        // æµ‹è¯• URL ç±»å‹æ£€æµ‹
        function testUrlDetection() {
            log('ğŸ§ª å¼€å§‹æµ‹è¯• URL ç±»å‹æ£€æµ‹...', 'info');
            
            const testUrls = [
                {
                    url: 'https://pub-d00e7b41917848d1a8403c984cb62880.r2.dev/generated/generated_12345.png',
                    expected: 'R2æ°¸ä¹…URL',
                    type: 'r2_permanent'
                },
                {
                    url: 'https://tempfile.aiquickdraw.com/s/33b96ee4-8a4b-4c7c-85b5-3c2b8e5a7d9f',
                    expected: 'KIEä¸´æ—¶URL',
                    type: 'kie_temporary'
                },
                {
                    url: 'https://example.com/image.jpg',
                    expected: 'æœªçŸ¥ç±»å‹URL',
                    type: 'unknown'
                }
            ];

            const resultDiv = document.getElementById('urlDetectionResult');
            let resultHtml = '<h4>URL æ£€æµ‹ç»“æœ:</h4>';

            testUrls.forEach((test, index) => {
                const isR2Url = test.url.includes('pub-d00e7b41917848d1a8403c984cb62880.r2.dev') || 
                               test.url.includes('.r2.dev') || 
                               test.url.includes('.r2.cloudflarestorage.com');
                
                const isTempUrl = test.url.includes('tempfile.aiquickdraw.com');
                
                let detectedType = 'unknown';
                if (isR2Url) detectedType = 'r2_permanent';
                else if (isTempUrl) detectedType = 'kie_temporary';

                const isCorrect = detectedType === test.type;
                const status = isCorrect ? 'success' : 'error';

                resultHtml += `
                    <div class="test-section ${status}">
                        <strong>æµ‹è¯• ${index + 1}:</strong><br>
                        URL: <code>${test.url}</code><br>
                        é¢„æœŸ: ${test.expected} | æ£€æµ‹: ${detectedType}<br>
                        <span class="status-indicator status-${isCorrect ? 'success' : 'error'}"></span>
                        ${isCorrect ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}
                    </div>
                `;

                log(`URLæ£€æµ‹ ${index + 1}: ${test.expected} -> ${detectedType} (${isCorrect ? 'é€šè¿‡' : 'å¤±è´¥'})`, isCorrect ? 'success' : 'error');
            });

            resultDiv.innerHTML = resultHtml;
            log('âœ… URL ç±»å‹æ£€æµ‹æµ‹è¯•å®Œæˆ', 'success');
        }

        // æ¨¡æ‹Ÿå›¾ç‰‡ç”Ÿæˆæµç¨‹
        async function simulateImageGeneration() {
            const generateBtn = document.getElementById('generateBtn');
            const statusDiv = document.getElementById('generationStatus');
            
            generateBtn.disabled = true;
            generateBtn.textContent = 'ç”Ÿæˆä¸­...';
            
            log('ğŸš€ å¼€å§‹æ¨¡æ‹Ÿå›¾ç‰‡ç”Ÿæˆæµç¨‹...', 'info');
            
            try {
                // æ¨¡æ‹Ÿç”Ÿæˆè¿‡ç¨‹
                statusDiv.innerHTML = '<div class="test-section info">ğŸ“ æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...</div>';
                await sleep(1000);

                // æ¨¡æ‹Ÿè·å–ä¸´æ—¶URL
                const tempUrl = 'https://tempfile.aiquickdraw.com/s/' + generateRandomId();
                log('ğŸ“¥ è·å–åˆ° KIE ä¸´æ—¶ URL: ' + tempUrl, 'info');
                statusDiv.innerHTML = '<div class="test-section warning">â³ è·å–åˆ°ä¸´æ—¶URLï¼Œæ­£åœ¨è½¬æ¢ä¸ºR2æ°¸ä¹…URL...</div>';
                
                await sleep(2000);

                // æ¨¡æ‹ŸR2ä¸Šä¼ æˆåŠŸ
                const r2Url = 'https://pub-d00e7b41917848d1a8403c984cb62880.r2.dev/generated/generated_' + generateRandomId() + '.png';
                currentGeneratedUrl = r2Url;
                
                log('âœ… æˆåŠŸè½¬æ¢ä¸º R2 æ°¸ä¹… URL: ' + r2Url, 'success');
                statusDiv.innerHTML = `
                    <div class="test-section success">
                        <span class="status-indicator status-success"></span>
                        <strong>âœ… å›¾ç‰‡ç”ŸæˆæˆåŠŸï¼</strong><br>
                        <div class="url-display">${r2Url}</div>
                        <small>âœ… å·²è·å– R2 æ°¸ä¹… URLï¼Œå¯ä»¥åˆ›å»ºåˆ†äº«</small>
                    </div>
                `;

                // å¯ç”¨åˆ†äº«æŒ‰é’®
                document.getElementById('shareBtn').disabled = false;
                
            } catch (error) {
                log('âŒ å›¾ç‰‡ç”Ÿæˆæ¨¡æ‹Ÿå¤±è´¥: ' + error.message, 'error');
                statusDiv.innerHTML = '<div class="test-section error">âŒ ç”Ÿæˆå¤±è´¥</div>';
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'æ¨¡æ‹Ÿå›¾ç‰‡ç”Ÿæˆ';
            }
        }

        // æµ‹è¯•åˆ†äº«åˆ›å»º
        async function testShareCreation() {
            if (!currentGeneratedUrl) {
                log('âŒ è¯·å…ˆæ¨¡æ‹Ÿå›¾ç‰‡ç”Ÿæˆ', 'error');
                return;
            }

            const shareBtn = document.getElementById('shareBtn');
            const resultDiv = document.getElementById('shareResult');
            
            shareBtn.disabled = true;
            shareBtn.textContent = 'åˆ›å»ºä¸­...';
            
            log('ğŸ“¤ å¼€å§‹åˆ›å»ºåˆ†äº«...', 'info');
            
            try {
                // æ£€æŸ¥URLç±»å‹
                const isR2Url = currentGeneratedUrl.includes('pub-d00e7b41917848d1a8403c984cb62880.r2.dev');
                log('ğŸ” URLç±»å‹æ£€æŸ¥: ' + (isR2Url ? 'R2æ°¸ä¹…URL âœ…' : 'ä¸´æ—¶URL âš ï¸'), isR2Url ? 'success' : 'warn');

                // æ¨¡æ‹Ÿåˆ†äº«APIè°ƒç”¨
                const shareData = {
                    generatedUrl: currentGeneratedUrl,
                    originalUrl: null,
                    prompt: 'æµ‹è¯•ç”Ÿæˆçš„å¯çˆ±åŠ¨æ¼«é£æ ¼å›¾ç‰‡',
                    style: 'åŠ¨æ¼«é£æ ¼',
                    timestamp: Date.now(),
                    isR2Stored: isR2Url
                };

                log('ğŸ“ åˆ†äº«æ•°æ®: ' + JSON.stringify(shareData, null, 2), 'info');
                
                resultDiv.innerHTML = '<div class="test-section info">ğŸ“¤ æ­£åœ¨åˆ›å»ºåˆ†äº«...</div>';
                await sleep(1000);

                // æ¨¡æ‹ŸæˆåŠŸå“åº”
                currentShareId = 'share_' + Date.now() + '_' + generateRandomId();
                currentShareUrl = `https://2kawaii.com/share/${currentShareId}`;
                
                log('âœ… åˆ†äº«åˆ›å»ºæˆåŠŸ: ' + currentShareUrl, 'success');
                
                resultDiv.innerHTML = `
                    <div class="test-section success">
                        <span class="status-indicator status-success"></span>
                        <strong>âœ… åˆ†äº«åˆ›å»ºæˆåŠŸï¼</strong><br>
                        <strong>åˆ†äº«ID:</strong> ${currentShareId}<br>
                        <strong>åˆ†äº«URL:</strong><br>
                        <div class="url-display">${currentShareUrl}</div>
                        <strong>ä½¿ç”¨çš„å›¾ç‰‡URL:</strong><br>
                        <div class="url-display">${currentGeneratedUrl}</div>
                        <small>âœ… ä½¿ç”¨äº† R2 æ°¸ä¹… URLï¼Œåˆ†äº«é¡µé¢å°†æ­£å¸¸æ˜¾ç¤º</small>
                    </div>
                `;

                // å¯ç”¨éªŒè¯æŒ‰é’®
                document.getElementById('verifyBtn').disabled = false;
                
            } catch (error) {
                log('âŒ åˆ†äº«åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
                resultDiv.innerHTML = '<div class="test-section error">âŒ åˆ†äº«åˆ›å»ºå¤±è´¥</div>';
            } finally {
                shareBtn.disabled = false;
                shareBtn.textContent = 'åˆ›å»ºåˆ†äº«';
            }
        }

        // éªŒè¯åˆ†äº«é¡µé¢
        async function testSharePage() {
            if (!currentShareUrl) {
                log('âŒ è¯·å…ˆåˆ›å»ºåˆ†äº«', 'error');
                return;
            }

            const verifyBtn = document.getElementById('verifyBtn');
            const resultDiv = document.getElementById('verifyResult');
            
            verifyBtn.disabled = true;
            verifyBtn.textContent = 'éªŒè¯ä¸­...';
            
            log('ğŸ” å¼€å§‹éªŒè¯åˆ†äº«é¡µé¢...', 'info');
            
            try {
                resultDiv.innerHTML = '<div class="test-section info">ğŸ” æ­£åœ¨éªŒè¯åˆ†äº«é¡µé¢...</div>';
                await sleep(1500);

                // æ¨¡æ‹Ÿåˆ†äº«é¡µé¢æ£€æŸ¥
                const checks = [
                    { name: 'åˆ†äº«URLå¯è®¿é—®æ€§', status: 'success', message: 'åˆ†äº«é¡µé¢å¯æ­£å¸¸è®¿é—®' },
                    { name: 'å›¾ç‰‡URLæœ‰æ•ˆæ€§', status: 'success', message: 'ä½¿ç”¨R2æ°¸ä¹…URLï¼Œå›¾ç‰‡æ­£å¸¸æ˜¾ç¤º' },
                    { name: 'å…ƒæ•°æ®å®Œæ•´æ€§', status: 'success', message: 'æ ‡é¢˜ã€æè¿°ã€å›¾ç‰‡ç­‰å…ƒæ•°æ®å®Œæ•´' },
                    { name: 'SEOä¼˜åŒ–', status: 'success', message: 'OpenGraphå’ŒTwitterå¡ç‰‡æ­£å¸¸' }
                ];

                let resultHtml = '<div class="test-section success"><h4>âœ… åˆ†äº«é¡µé¢éªŒè¯ç»“æœ:</h4>';
                
                checks.forEach(check => {
                    resultHtml += `
                        <div style="margin: 8px 0;">
                            <span class="status-indicator status-${check.status}"></span>
                            <strong>${check.name}:</strong> ${check.message}
                        </div>
                    `;
                    log(`âœ… ${check.name}: ${check.message}`, 'success');
                });

                resultHtml += `
                    <div style="margin-top: 15px;">
                        <strong>ğŸ‰ æµ‹è¯•æ€»ç»“:</strong><br>
                        âœ… åˆ†äº«é¡µé¢æˆåŠŸä½¿ç”¨ R2 æ°¸ä¹… URL<br>
                        âœ… å›¾ç‰‡å¯æ­£å¸¸æ˜¾ç¤ºï¼Œä¸ä¾èµ–ä¸´æ—¶é“¾æ¥<br>
                        âœ… åˆ†äº«åŠŸèƒ½å®Œå…¨æ­£å¸¸<br>
                        <br>
                        <a href="${currentShareUrl}" target="_blank" style="color: #4CAF50; text-decoration: none;">
                            ğŸ”— ç‚¹å‡»è®¿é—®åˆ†äº«é¡µé¢
                        </a>
                    </div>
                </div>`;

                resultDiv.innerHTML = resultHtml;
                log('ğŸ‰ åˆ†äº«é¡µé¢éªŒè¯å®Œæˆï¼Œæ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼', 'success');
                
            } catch (error) {
                log('âŒ åˆ†äº«é¡µé¢éªŒè¯å¤±è´¥: ' + error.message, 'error');
                resultDiv.innerHTML = '<div class="test-section error">âŒ éªŒè¯å¤±è´¥</div>';
            } finally {
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'éªŒè¯åˆ†äº«é¡µé¢';
            }
        }

        // è¾…åŠ©å‡½æ•°
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function generateRandomId() {
            return Math.random().toString(36).substring(2, 15);
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ”§ åˆ†äº«é¡µé¢ R2 URL ä¿®å¤æµ‹è¯•å·¥å…·å·²å°±ç»ª', 'success');
            log('ğŸ“‹ è¯·æŒ‰é¡ºåºæ‰§è¡Œæµ‹è¯•ï¼šURLæ£€æµ‹ -> æ¨¡æ‹Ÿç”Ÿæˆ -> åˆ›å»ºåˆ†äº« -> éªŒè¯é¡µé¢', 'info');
        });
    </script>
</body>
</html>
