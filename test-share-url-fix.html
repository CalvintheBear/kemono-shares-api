<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†äº«URLä¿®å¤éªŒè¯</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        .success { border-left: 4px solid #4CAF50; background-color: #f8fff8; }
        .warning { border-left: 4px solid #FF9800; background-color: #fffbf0; }
        .error { border-left: 4px solid #f44336; background-color: #fff8f8; }
        .info { border-left: 4px solid #2196F3; background-color: #f0f8ff; }
        
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #45a049; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        
        .url-display {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            word-break: break-all;
            font-family: monospace;
            font-size: 12px;
        }
        .log-area {
            background-color: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .before, .after {
            padding: 15px;
            border-radius: 8px;
        }
        .before { background-color: #ffebee; }
        .after { background-color: #e8f5e8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ åˆ†äº«URLä¿®å¤éªŒè¯å·¥å…·</h1>
        <p>éªŒè¯åˆ†äº«é¡µé¢æ˜¯å¦æ­£ç¡®ä½¿ç”¨R2æ°¸ä¹…URLè€Œä¸æ˜¯ä¸´æ—¶URL</p>
    </div>

    <div class="container">
        <h2>ğŸ“‹ é—®é¢˜åˆ†æ</h2>
        
        <div class="test-section error">
            <h3>ğŸš¨ å‘ç°çš„é—®é¢˜</h3>
            <ul>
                <li><strong>original_url ä½¿ç”¨äº† base64 æ•°æ®</strong>ï¼š`data:image/jpeg;base64,/9j/...`</li>
                <li><strong>åˆ†äº«API GETè¯·æ±‚è¿”å›501é”™è¯¯</strong>ï¼šæ— æ³•è·å–åˆ†äº«æ•°æ®</li>
                <li><strong>completedResultä½¿ç”¨äº†é”™è¯¯çš„original_url</strong>ï¼šä½¿ç”¨imagePreviewè€Œä¸æ˜¯fileUrl</li>
                <li><strong>handleShareå‡½æ•°é‡å¤åˆ¤æ–­originalUrl</strong>ï¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´</li>
            </ul>
        </div>

        <div class="comparison">
            <div class="before">
                <h4>âŒ ä¿®å¤å‰çš„æµç¨‹</h4>
                <ol>
                    <li>å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼Œè·å–R2 URL</li>
                    <li>è®¾ç½®completedResultæ—¶ä½¿ç”¨base64çš„imagePreview</li>
                    <li>handleShareé‡æ–°åˆ¤æ–­originalUrlï¼Œè¿‡æ»¤æ‰base64</li>
                    <li>åˆ†äº«API GETè¿”å›501ï¼Œåˆ†äº«é¡µé¢æ— æ³•åŠ è½½</li>
                    <li>ç”¨æˆ·çœ‹åˆ°çš„æ˜¯é”™è¯¯é¡µé¢</li>
                </ol>
            </div>
            <div class="after">
                <h4>âœ… ä¿®å¤åçš„æµç¨‹</h4>
                <ol>
                    <li>å›¾ç‰‡ç”Ÿæˆå®Œæˆï¼Œè·å–R2 URL</li>
                    <li>è®¾ç½®completedResultæ—¶ä½¿ç”¨åŸå§‹fileUrl</li>
                    <li>handleShareç›´æ¥ä½¿ç”¨resultæ•°æ®ï¼Œä¸é‡å¤åˆ¤æ–­</li>
                    <li>åˆ†äº«API GETæ­£ç¡®è¿”å›å­˜å‚¨çš„æ•°æ®</li>
                    <li>åˆ†äº«é¡µé¢æ˜¾ç¤ºæ­£ç¡®çš„R2 URLå›¾ç‰‡</li>
                </ol>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ”§ ä¿®å¤å†…å®¹è¯¦è§£</h2>

        <div class="test-section success">
            <h3>1. ä¿®å¤ completedResult ä¸­çš„ original_url</h3>
            <p><strong>ä¿®å¤å‰ï¼š</strong></p>
            <div class="url-display">original_url: mode === 'text-to-image' ? '' : imagePreview! // âŒ base64æ•°æ®</div>
            <p><strong>ä¿®å¤åï¼š</strong></p>
            <div class="url-display">original_url: mode === 'text-to-image' ? '' : (fileUrl || '') // âœ… åŸå§‹URL</div>
        </div>

        <div class="test-section success">
            <h3>2. ç®€åŒ– handleShare å‡½æ•°é€»è¾‘</h3>
            <p><strong>ä¿®å¤å‰ï¼š</strong></p>
            <div class="url-display">
// é‡å¤åˆ¤æ–­å’Œè¿‡æ»¤originalUrl
if (fileUrl && !fileUrl.startsWith('data:image/')) {
  originalUrl = fileUrl
}
            </div>
            <p><strong>ä¿®å¤åï¼š</strong></p>
            <div class="url-display">
// ç›´æ¥ä½¿ç”¨resultä¸­çš„æ•°æ®
const originalUrl = result.original_url && result.original_url.trim() !== '' ? result.original_url : null
            </div>
        </div>

        <div class="test-section success">
            <h3>3. ä¿®å¤åˆ†äº«API GETè¯·æ±‚</h3>
            <p><strong>ä¿®å¤å‰ï¼š</strong></p>
            <div class="url-display">return new Response(JSON.stringify({ error: 'API not available' }), { status: 501 })</div>
            <p><strong>ä¿®å¤åï¼š</strong></p>
            <div class="url-display">
// ä»å†…å­˜å­˜å‚¨ä¸­è·å–åˆ†äº«æ•°æ®
const shareData = globalThis.shareDataStore.get(shareId);
return new Response(JSON.stringify({ success: true, data: shareData }))
            </div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ§ª éªŒè¯æµ‹è¯•</h2>
        
        <div class="test-section info">
            <h3>æµ‹è¯•åœºæ™¯</h3>
            <button onclick="testUrlTypes()">æµ‹è¯•URLç±»å‹æ£€æµ‹</button>
            <button onclick="testShareFlow()">æµ‹è¯•åˆ†äº«æµç¨‹</button>
            <button onclick="testApiEndpoints()">æµ‹è¯•APIç«¯ç‚¹</button>
            <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“Š æµ‹è¯•æ—¥å¿—</h2>
        <div class="log-area" id="logArea"></div>
    </div>

    <script>
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logArea = document.getElementById('logArea');
            const color = {
                'info': '#00ff00',
                'warn': '#ffff00',
                'error': '#ff0000',
                'success': '#00ff88'
            }[type] || '#00ff00';
            
            logArea.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logArea').innerHTML = '';
        }

        // æµ‹è¯•URLç±»å‹æ£€æµ‹
        function testUrlTypes() {
            log('ğŸ§ª å¼€å§‹æµ‹è¯•URLç±»å‹æ£€æµ‹...', 'info');
            
            const testUrls = [
                {
                    url: 'https://pub-d00e7b41917848d1a8403c984cb62880.r2.dev/generated/generated_5fa1e650bf8a6ca718581dfcd5dca896.png',
                    expected: 'R2æ°¸ä¹…URL',
                    shouldBeR2: true
                },
                {
                    url: 'https://tempfile.aiquickdraw.com/s/33b96ee4-8a4b-4c7c-85b5-3c2b8e5a7d9f',
                    expected: 'KIEä¸´æ—¶URL',
                    shouldBeR2: false
                },
                {
                    url: 'data:image/jpeg;base64,/9j/4QC8RXhpZgAATU0AKgAAAAg...',
                    expected: 'Base64æ•°æ®',
                    shouldBeR2: false
                }
            ];

            testUrls.forEach((test, index) => {
                const isR2Url = test.url.includes('pub-d00e7b41917848d1a8403c984cb62880.r2.dev') || 
                               test.url.includes('.r2.dev') || 
                               test.url.includes('.r2.cloudflarestorage.com');
                
                const result = isR2Url === test.shouldBeR2 ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥';
                const logType = isR2Url === test.shouldBeR2 ? 'success' : 'error';
                
                log(`æµ‹è¯• ${index + 1}: ${test.expected} -> ${isR2Url ? 'R2 URL' : 'éR2 URL'} ${result}`, logType);
            });
            
            log('âœ… URLç±»å‹æ£€æµ‹æµ‹è¯•å®Œæˆ', 'success');
        }

        // æµ‹è¯•åˆ†äº«æµç¨‹
        async function testShareFlow() {
            log('ğŸ”„ å¼€å§‹æµ‹è¯•åˆ†äº«æµç¨‹...', 'info');
            
            try {
                // æ¨¡æ‹Ÿåˆ†äº«æ•°æ®
                const mockShareData = {
                    generatedUrl: 'https://pub-d00e7b41917848d1a8403c984cb62880.r2.dev/generated/generated_5fa1e650bf8a6ca718581dfcd5dca896.png',
                    originalUrl: 'https://example.com/original.jpg',
                    prompt: 'æµ‹è¯•ç”Ÿæˆçš„å¯çˆ±åŠ¨æ¼«é£æ ¼å›¾ç‰‡',
                    style: 'åŠ¨æ¼«é£æ ¼',
                    timestamp: Date.now(),
                    isR2Stored: true
                };

                log('ğŸ“¤ æ¨¡æ‹Ÿåˆ›å»ºåˆ†äº«è¯·æ±‚...', 'info');
                log(`ç”Ÿæˆå›¾URL: ${mockShareData.generatedUrl}`, 'info');
                log(`åŸå›¾URL: ${mockShareData.originalUrl}`, 'info');
                log(`æ˜¯å¦R2å­˜å‚¨: ${mockShareData.isR2Stored}`, 'info');

                // æ£€æŸ¥URLç±»å‹
                const isR2Url = mockShareData.generatedUrl.includes('pub-d00e7b41917848d1a8403c984cb62880.r2.dev');
                log(`URLç±»å‹æ£€æŸ¥: ${isR2Url ? 'R2æ°¸ä¹…URL âœ…' : 'ä¸´æ—¶URL âš ï¸'}`, isR2Url ? 'success' : 'warn');

                if (isR2Url) {
                    log('âœ… åˆ†äº«æµç¨‹éªŒè¯é€šè¿‡ï¼šä½¿ç”¨R2æ°¸ä¹…URL', 'success');
                } else {
                    log('âš ï¸ åˆ†äº«æµç¨‹éœ€è¦ä¼˜åŒ–ï¼šä»ä½¿ç”¨ä¸´æ—¶URL', 'warn');
                }

            } catch (error) {
                log('âŒ åˆ†äº«æµç¨‹æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯•APIç«¯ç‚¹
        async function testApiEndpoints() {
            log('ğŸ”Œ å¼€å§‹æµ‹è¯•APIç«¯ç‚¹...', 'info');
            
            try {
                // æµ‹è¯•åˆ†äº«API POST
                log('ğŸ“ æµ‹è¯•åˆ†äº«åˆ›å»ºAPI...', 'info');
                const mockData = {
                    generatedUrl: 'https://pub-d00e7b41917848d1a8403c984cb62880.r2.dev/generated/test.png',
                    originalUrl: null,
                    prompt: 'APIæµ‹è¯•',
                    style: 'æµ‹è¯•é£æ ¼',
                    timestamp: Date.now(),
                    isR2Stored: true
                };

                log('è¯·æ±‚æ•°æ®: ' + JSON.stringify(mockData, null, 2), 'info');
                log('âœ… APIç«¯ç‚¹æµ‹è¯•æ¨¡æ‹Ÿå®Œæˆ', 'success');
                
            } catch (error) {
                log('âŒ APIç«¯ç‚¹æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ”§ åˆ†äº«URLä¿®å¤éªŒè¯å·¥å…·å·²å°±ç»ª', 'success');
            log('ğŸ“‹ ä¸»è¦ä¿®å¤å†…å®¹ï¼š', 'info');
            log('  1. ä¿®å¤completedResultä¸­çš„original_urlä½¿ç”¨fileUrlè€Œä¸æ˜¯base64', 'info');
            log('  2. ç®€åŒ–handleShareå‡½æ•°ï¼Œç›´æ¥ä½¿ç”¨resultæ•°æ®', 'info');
            log('  3. ä¿®å¤åˆ†äº«API GETè¯·æ±‚ï¼Œæ­£ç¡®è¿”å›å­˜å‚¨çš„æ•°æ®', 'info');
            log('  4. ç¡®ä¿åˆ†äº«é¡µé¢ä½¿ç”¨R2æ°¸ä¹…URLæ˜¾ç¤ºå›¾ç‰‡', 'info');
            log('ğŸ§ª è¯·è¿è¡Œæµ‹è¯•éªŒè¯ä¿®å¤æ•ˆæœ', 'info');
        });
    </script>
</body>
</html>
