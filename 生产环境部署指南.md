# 🚀 FuryCode 生产环境部署指南

## 📋 项目概述

**FuryCode** 是一个基于 Next.js 15 的 AI 图像生成应用，支持多种动漫风格转换。

### 核心技术栈
- **框架**: Next.js 15 + TypeScript
- **样式**: Tailwind CSS v4
- **状态管理**: Zustand
- **国际化**: next-intl (日语)
- **图像处理**: KIE AI GPT-4o Image API
- **存储**: Cloudflare R2 + ImgBB
- **部署**: Cloudflare Workers/Pages + Railway

---

## 🎯 部署选项

### 选项 1: Cloudflare 部署（推荐）
- ✅ 全球 CDN 加速
- ✅ 无服务器架构
- ✅ 自动扩展
- ✅ 成本低廉

### 选项 2: Railway 部署
- ✅ 简单易用
- ✅ 自动部署
- ✅ 数据库支持
- ✅ 实时日志

---

## 🔧 Cloudflare 部署指南

### 第一步：创建 Cloudflare 账户和配置

#### 1.1 创建 Cloudflare 账户
1. 访问 [cloudflare.com](https://cloudflare.com)
2. 注册账户并完成邮箱验证
3. 记录您的 **Account ID**（在右侧边栏可见）

#### 1.2 创建 API Token
1. 进入 **My Profile** → **API Tokens**
2. 点击 **Create Token**
3. 使用 **Custom token** 模板
4. 配置权限：
   ```
   Permissions:
   - Zone:Zone:Read
   - Zone:Zone Settings:Edit
   - Zone:DNS:Edit
   - Account:Cloudflare Pages:Edit
   - Account:Account Settings:Read
   - User:User Details:Read
   ```
5. 保存生成的 **API Token**

#### 1.3 设置 Cloudflare R2 存储

##### 创建 R2 存储桶
1. 进入 **R2 Object Storage**
2. 创建存储桶：
   - 主存储桶: `kemono-uploadimage`
   - 生成图存储桶: `kemono-afterimage`

##### 创建 R2 API Token
1. 在 **R2** → **Manage R2 API tokens**
2. 点击 **Create API token**
3. 权限设置：
   ```
   Permissions: Admin Read & Write
   Include All R2 buckets
   ```
4. 保存以下信息：
   - **Access Key ID**
   - **Secret Access Key**

##### 配置自定义域名（可选）
1. 进入存储桶设置
2. 点击 **Settings** → **Public access**
3. 点击 **Connect Domain**
4. 输入域名（如：`images.yourdomain.com`）

### 第二步：配置环境变量

创建 `.env.production` 文件：

```bash
# KIE AI API配置
KIE_API_KEY=your_kie_api_key_here
KIE_AI_USER_ID=your_user_id_here
KIE_AI_BASE_URL=https://api.kie.ai
KIE_AI_40_BASE_URL=https://api.kie.ai
KIE_AI_EDGE_BASE=https://api.kie.ai/api/v1

# Cloudflare R2 存储配置
CLOUDFLARE_R2_ACCOUNT_ID=your_account_id_here
CLOUDFLARE_R2_ACCESS_KEY_ID=your_r2_access_key_here
CLOUDFLARE_R2_SECRET_ACCESS_KEY=your_r2_secret_key_here
CLOUDFLARE_R2_BUCKET_NAME=kemono-uploadimage
CLOUDFLARE_R2_PUBLIC_URL=https://pub-xxxxx.r2.dev
CLOUDFLARE_R2_AFTERIMAGE_BUCKET_NAME=kemono-afterimage
CLOUDFLARE_R2_AFTERIMAGE_PUBLIC_URL=https://pub-yyyyy.r2.dev

# Cloudflare API
CLOUDFLARE_API_TOKEN=your_cloudflare_api_token

# 应用配置
NEXT_PUBLIC_APP_URL=https://yourdomain.com
NODE_ENV=production
```

### 第三步：部署到 Cloudflare Pages

#### 3.1 使用 Wrangler CLI 部署

```bash
# 安装 Wrangler CLI
npm install -g wrangler

# 登录 Cloudflare
wrangler login

# 部署到 Cloudflare Pages
npm run pages:build
npm run pages:deploy
```

#### 3.2 通过 Git 集成部署

1. 将代码推送到 GitHub：
```bash
git add .
git commit -m "Production deployment setup"
git push origin main
```

2. 在 Cloudflare Dashboard：
   - 进入 **Pages**
   - 点击 **Create a project**
   - 连接 GitHub 仓库
   - 选择 `furycode - 副本` 仓库

3. 构建设置：
```yaml
Build command: npm run build
Build output directory: .next
Root directory: /
Node.js version: 20
```

4. 添加环境变量：
   - 在 **Settings** → **Environment variables**
   - 添加上述所有环境变量

### 第四步：配置自定义域名

#### 4.1 在 Cloudflare Pages 中添加域名
1. 在 Pages 项目中点击 **Custom domains**
2. 点击 **Set up a custom domain**
3. 输入您的域名（如：`app.yourdomain.com`）

#### 4.2 配置 DNS 记录（稍后在 DNS 部分详述）

---

## 🚂 Railway 部署指南

### 第一步：创建 Railway 账户

1. 访问 [railway.app](https://railway.app)
2. 使用 GitHub 账户登录
3. 完成账户设置

### 第二步：创建新项目

1. 点击 **New Project**
2. 选择 **Deploy from GitHub repo**
3. 选择 `furycode - 副本` 仓库
4. 点击 **Deploy Now**

### 第三步：配置环境变量

在 Railway Dashboard 中：
1. 选择您的项目
2. 点击 **Variables** 选项卡
3. 添加以下环境变量：

```bash
# KIE AI API配置
KIE_API_KEY=your_kie_api_key_here
KIE_AI_USER_ID=your_user_id_here
KIE_AI_BASE_URL=https://api.kie.ai

# Cloudflare R2 存储配置
CLOUDFLARE_R2_ACCOUNT_ID=your_account_id_here
CLOUDFLARE_R2_ACCESS_KEY_ID=your_r2_access_key_here
CLOUDFLARE_R2_SECRET_ACCESS_KEY=your_r2_secret_key_here
CLOUDFLARE_R2_BUCKET_NAME=kemono-uploadimage
CLOUDFLARE_R2_PUBLIC_URL=https://pub-xxxxx.r2.dev
CLOUDFLARE_R2_AFTERIMAGE_BUCKET_NAME=kemono-afterimage
CLOUDFLARE_R2_AFTERIMAGE_PUBLIC_URL=https://pub-yyyyy.r2.dev

# 应用配置
NEXT_PUBLIC_APP_URL=https://yourdomain.up.railway.app
NODE_ENV=production
PORT=3000
```

### 第四步：配置部署设置

#### 4.1 创建 `railway.json` 配置文件

```json
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS",
    "buildCommand": "npm run build"
  },
  "deploy": {
    "startCommand": "npm start",
    "healthcheckPath": "/",
    "healthcheckTimeout": 100,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}
```

#### 4.2 配置自定义域名

1. 在项目设置中点击 **Domains**
2. 点击 **Custom Domain**
3. 输入您的域名
4. Railway 会提供 CNAME 记录用于 DNS 配置

---

## 🌐 DNS 配置指南（Namesilo）

### 第一步：登录 Namesilo

1. 访问 [namesilo.com](https://namesilo.com)
2. 登录您的账户
3. 进入 **Domain Manager**

### 第二步：配置 DNS 记录

#### 2.1 对于 Cloudflare 部署

**选项 A：使用 Cloudflare DNS（推荐）**

1. 在 Namesilo 中修改名称服务器：
```
ns1.cloudflare.com
ns2.cloudflare.com
```

2. 在 Cloudflare Dashboard 中添加域名：
   - 点击 **Add a Site**
   - 输入您的域名
   - 选择免费计划
   - 复制现有 DNS 记录

3. 添加 DNS 记录：
```
Type: CNAME
Name: @（或 www）
Target: your-project.pages.dev
Proxy status: Proxied (橙色云朵)

Type: CNAME  
Name: app
Target: your-project.pages.dev
Proxy status: Proxied
```

**选项 B：直接在 Namesilo 配置**

```
Type: CNAME
Host: @
Value: your-project.pages.dev
TTL: 3600

Type: CNAME
Host: www
Value: your-project.pages.dev  
TTL: 3600
```

#### 2.2 对于 Railway 部署

在 Namesilo DNS 管理中添加：

```
Type: CNAME
Host: @
Value: your-project.up.railway.app
TTL: 3600

Type: CNAME
Host: www  
Value: your-project.up.railway.app
TTL: 3600
```

### 第三步：SSL 证书配置

#### Cloudflare（自动）
- SSL 证书自动配置
- 支持 Full (Strict) SSL

#### Railway（自动）  
- 自动配置 Let's Encrypt 证书
- HTTPS 自动重定向

---

## ⚙️ 环境变量详细配置

### 核心环境变量

| 变量名 | 说明 | 示例值 | 必需 |
|--------|------|--------|------|
| `KIE_API_KEY` | KIE AI API 密钥 | `sk-xxxxx` | ✅ |
| `KIE_AI_USER_ID` | KIE AI 用户ID | `user@example.com` | ✅ |
| `CLOUDFLARE_R2_ACCOUNT_ID` | Cloudflare 账户ID | `9a5ff316a26b8abb696af519e515d2de` | ✅ |
| `CLOUDFLARE_R2_ACCESS_KEY_ID` | R2 访问密钥ID | `xxxxxxxxxxxxx` | ✅ |
| `CLOUDFLARE_R2_SECRET_ACCESS_KEY` | R2 访问密钥 | `xxxxxxxxxxxxxx` | ✅ |
| `CLOUDFLARE_R2_BUCKET_NAME` | 主存储桶名称 | `kemono-uploadimage` | ✅ |
| `CLOUDFLARE_R2_PUBLIC_URL` | 主存储桶公开URL | `https://pub-xxx.r2.dev` | ✅ |
| `CLOUDFLARE_R2_AFTERIMAGE_BUCKET_NAME` | 生成图存储桶 | `kemono-afterimage` | ✅ |
| `CLOUDFLARE_R2_AFTERIMAGE_PUBLIC_URL` | 生成图存储桶URL | `https://pub-yyy.r2.dev` | ✅ |
| `NEXT_PUBLIC_APP_URL` | 应用公开URL | `https://yourdomain.com` | ✅ |
| `NODE_ENV` | 环境模式 | `production` | ✅ |

### 可选环境变量

| 变量名 | 说明 | 默认值 |
|--------|------|--------|
| `KIE_AI_BASE_URL` | KIE AI API 基础URL | `https://api.kie.ai` |
| `CLOUDFLARE_API_TOKEN` | Cloudflare API Token | - |
| `PORT` | 应用端口（Railway） | `3000` |

---

## 🔍 部署验证和测试

### 第一步：基础功能测试

#### 1.1 健康检查
```bash
# 测试应用是否正常运行
curl -I https://yourdomain.com

# 期望响应：HTTP/2 200
```

#### 1.2 API 测试
```bash
# 测试环境变量配置
curl https://yourdomain.com/api/test-env

# 测试 R2 配置
curl https://yourdomain.com/api/check-r2-config

# 测试分享功能
curl "https://yourdomain.com/api/share/list?limit=5&offset=0"
```

### 第二步：功能测试

#### 2.1 图像上传测试
1. 访问应用主页
2. 上传测试图像
3. 验证图像是否正确显示

#### 2.2 AI 生成测试  
1. 选择动漫风格
2. 提交生成请求
3. 验证进度显示和结果

#### 2.3 分享功能测试
1. 生成图像后分享
2. 访问分享链接
3. 验证图像和元数据

### 第三步：性能测试

```bash
# 使用 lighthouse 测试性能
npx lighthouse https://yourdomain.com --output=html

# 使用 PageSpeed Insights
# 访问：https://pagespeed.web.dev/
```

---

## 📊 监控和维护

### 第一步：设置监控

#### Cloudflare Analytics
1. 在 Cloudflare Dashboard 查看：
   - 流量统计
   - 性能指标  
   - 错误率

#### Railway Analytics  
1. 在 Railway Dashboard 查看：
   - CPU/内存使用
   - 响应时间
   - 错误日志

### 第二步：日志监控

#### 查看应用日志
```bash
# Cloudflare Workers 日志
wrangler tail

# Railway 日志
railway logs
```

#### 设置告警
- 配置错误率告警
- 设置响应时间告警
- 监控存储使用量

### 第三步：备份策略

#### 代码备份
```bash
# 定期推送到 GitHub
git add .
git commit -m "Production backup $(date)"
git push origin main
```

#### 数据备份
- R2 存储桶定期备份
- KV 存储数据导出
- 配置文件备份

---

## 🚨 故障排除

### 常见问题

#### 1. 构建失败
```bash
# 检查 Node.js 版本
node --version  # 应该 >= 20.0.0

# 清除缓存重新构建
npm run clean
npm install
npm run build
```

#### 2. 环境变量问题
```bash
# 本地测试环境变量
node -e "console.log(process.env.KIE_API_KEY)"

# 验证 R2 配置
npm run test:r2-config
```

#### 3. API 连接问题
```bash
# 测试 KIE AI 连接
npm run test:kie-connection

# 测试代理配置
npm run test:proxy
```

#### 4. DNS 解析问题
```bash
# 检查 DNS 记录
nslookup yourdomain.com

# 检查 CNAME 记录
dig CNAME yourdomain.com
```

### 回滚方案

#### Cloudflare Pages
1. 在 Dashboard 中选择之前的部署版本
2. 点击 **Rollback to this deployment**

#### Railway
```bash
# 查看部署历史
railway status

# 回滚到指定版本  
railway rollback <deployment-id>
```

---

## 📈 性能优化建议

### 第一步：缓存优化

#### Cloudflare 缓存规则
```yaml
Page Rules:
- *.yourdomain.com/api/*
  Cache Level: Bypass
  
- *.yourdomain.com/_next/static/*
  Cache Level: Cache Everything
  Edge Cache TTL: 1 month
```

#### 图像优化
- 启用 Cloudflare 图像优化
- 使用 WebP 格式
- 压缩图像质量

### 第二步：代码优化

#### Next.js 优化
```javascript
// next.config.ts
const nextConfig = {
  compress: true,
  poweredByHeader: false,
  generateEtags: false,
  images: {
    unoptimized: false,
    formats: ['image/webp', 'image/avif'],
  },
};
```

#### 包大小优化
```bash
# 分析包大小
npm run build
npx @next/bundle-analyzer

# 移除未使用的依赖
npm prune
```

---

## 💰 成本预估

### Cloudflare 费用
- **Pages**: 免费（100,000 请求/月）
- **R2 存储**: $0.015/GB/月
- **CDN 流量**: 免费（100GB/月）
- **DNS**: 免费
- **SSL**: 免费

### Railway 费用  
- **Hobby 计划**: $5/月
- **Pro 计划**: $20/月（推荐生产环境）

### 总成本预估
- **小型项目**: $0-10/月
- **中型项目**: $20-50/月  
- **大型项目**: $50-200/月

---

## 📞 技术支持

### 官方文档
- [Next.js 文档](https://nextjs.org/docs)
- [Cloudflare Pages](https://developers.cloudflare.com/pages/)
- [Railway 文档](https://docs.railway.app/)
- [Namesilo DNS](https://www.namesilo.com/support)

### 社区支持
- GitHub Issues: [项目仓库]/issues
- Discord: Next.js 官方频道
- Stack Overflow: nextjs, cloudflare, railway 标签

---

## ✅ 部署检查清单

### 部署前检查
- [ ] 代码已提交到 Git 仓库
- [ ] 环境变量已配置完成
- [ ] KIE AI API 密钥有效
- [ ] Cloudflare R2 存储桶已创建
- [ ] DNS 记录已配置
- [ ] SSL 证书已验证

### 部署后验证
- [ ] 应用可以正常访问
- [ ] 图像上传功能正常
- [ ] AI 生成功能正常
- [ ] 分享功能正常
- [ ] 多语言切换正常
- [ ] 性能指标正常
- [ ] 监控告警已设置

---

**部署完成！🎉**

您的 FuryCode 应用现已成功部署到生产环境。请保存好所有配置信息，并定期进行备份和监控。

如果遇到任何问题，请参考故障排除部分或联系技术支持。