<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”»å»Šç­›é€‰è°ƒè¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.danger {
            background: #dc3545;
        }
        .button.danger:hover {
            background: #c82333;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }
        .error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ç”»å»Šç­›é€‰è°ƒè¯•å·¥å…·</h1>
        <p>è¿™ä¸ªå·¥å…·å¯ä»¥å¸®åŠ©ä½ è°ƒè¯•ç”»å»Šç­›é€‰é€»è¾‘ï¼Œç¡®ä¿å›¾ç”Ÿå›¾å’Œæ¨¡æ¿æ¨¡å¼çš„å›¾ç‰‡ä¸ä¼šæ˜¾ç¤ºåœ¨ç”»å»Šä¸­ã€‚</p>
        
        <div>
            <button class="button" onclick="debugGalleryFilter()">ğŸ” è°ƒè¯•ç”»å»Šç­›é€‰</button>
            <button class="button danger" onclick="clearCacheAndTest()">ğŸ§¹ æ¸…é™¤ç¼“å­˜å¹¶æµ‹è¯•</button>
            <button class="button" onclick="testFilterLogic()">ğŸ§ª æµ‹è¯•ç­›é€‰é€»è¾‘</button>
        </div>
        
        <div id="result" class="result" style="display: none;"></div>
    </div>

    <script>
        // è°ƒè¯•ç”»å»Šç­›é€‰é—®é¢˜
        const debugGalleryFilter = async () => {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'ğŸ” å¼€å§‹è°ƒè¯•ç”»å»Šç­›é€‰é—®é¢˜...\n';
            
            try {
                // 1. ç›´æ¥è°ƒç”¨APIè·å–åŸå§‹æ•°æ®
                resultDiv.textContent += 'ğŸ“¡ è·å–åŸå§‹åˆ†äº«åˆ—è¡¨æ•°æ®...\n';
                const response = await fetch('/api/share/list?limit=50&offset=0');
                const result = await response.json();
                
                if (!result.success) {
                    resultDiv.textContent += `âŒ APIè¯·æ±‚å¤±è´¥: ${result.error}\n`;
                    resultDiv.className = 'result error';
                    return;
                }
                
                resultDiv.textContent += `ğŸ“Š APIè¿”å›æ•°æ®: æ€»æ•°=${result.data.total}, å½“å‰é¡µ=${result.data.items.length}\n\n`;
                
                // 2. åˆ†ææ¯ä¸ªåˆ†äº«é¡¹
                resultDiv.textContent += 'ğŸ” åˆ†æåˆ†äº«é¡¹:\n';
                result.data.items.forEach((item, index) => {
                    const hasOriginalUrl = item.originalUrl && 
                        typeof item.originalUrl === 'string' && 
                        item.originalUrl.trim() !== '' &&
                        !item.originalUrl.startsWith('data:image/') &&
                        !item.originalUrl.includes('placeholder.com') &&
                        !item.originalUrl.includes('Text+to+Image') &&
                        !item.originalUrl.includes('base64') &&
                        item.originalUrl.length <= 1000;
                    
                    resultDiv.textContent += `${index + 1}. ID: ${item.id}\n`;
                    resultDiv.textContent += `   Style: ${item.style}\n`;
                    resultDiv.textContent += `   OriginalUrl: ${item.originalUrl || 'null'}\n`;
                    resultDiv.textContent += `   HasValidOriginalUrl: ${hasOriginalUrl}\n`;
                    resultDiv.textContent += `   ShouldShowInGallery: ${!hasOriginalUrl}\n\n`;
                });
                
                // 3. ç»Ÿè®¡ç»“æœ
                const textToImageCount = result.data.items.filter(item => {
                    const hasOriginalUrl = item.originalUrl && 
                        typeof item.originalUrl === 'string' && 
                        item.originalUrl.trim() !== '' &&
                        !item.originalUrl.startsWith('data:image/') &&
                        !item.originalUrl.includes('placeholder.com') &&
                        !item.originalUrl.includes('Text+to+Image') &&
                        !item.originalUrl.includes('base64') &&
                        item.originalUrl.length <= 1000;
                    return !hasOriginalUrl;
                }).length;
                
                const imageToImageCount = result.data.items.length - textToImageCount;
                
                resultDiv.textContent += 'ğŸ“ˆ ç»Ÿè®¡ç»“æœ:\n';
                resultDiv.textContent += `æ€»åˆ†äº«æ•°: ${result.data.items.length}\n`;
                resultDiv.textContent += `æ–‡ç”Ÿå›¾(ç”»å»Šæ˜¾ç¤º): ${textToImageCount}\n`;
                resultDiv.textContent += `å›¾ç”Ÿå›¾(ç”»å»Šéšè—): ${imageToImageCount}\n\n`;
                
                // 4. æ£€æŸ¥æ˜¯å¦æœ‰å›¾ç”Ÿå›¾æ˜¾ç¤ºåœ¨ç”»å»Šä¸­
                const imageToImageItems = result.data.items.filter(item => {
                    const hasOriginalUrl = item.originalUrl && 
                        typeof item.originalUrl === 'string' && 
                        item.originalUrl.trim() !== '' &&
                        !item.originalUrl.startsWith('data:image/') &&
                        !item.originalUrl.includes('placeholder.com') &&
                        !item.originalUrl.includes('Text+to+Image') &&
                        !item.originalUrl.includes('base64') &&
                        item.originalUrl.length <= 1000;
                    return hasOriginalUrl;
                });
                
                if (imageToImageItems.length > 0) {
                    resultDiv.textContent += 'âš ï¸ å‘ç°é—®é¢˜ï¼šä»¥ä¸‹å›¾ç”Ÿå›¾é¡¹ç›®ä»ç„¶æ˜¾ç¤ºåœ¨ç”»å»Šä¸­:\n';
                    imageToImageItems.forEach(item => {
                        resultDiv.textContent += `  - ${item.id}: ${item.style} (OriginalUrl: ${item.originalUrl})\n`;
                    });
                    resultDiv.className = 'result error';
                } else {
                    resultDiv.textContent += 'âœ… ç­›é€‰é€»è¾‘å·¥ä½œæ­£å¸¸ï¼Œæ²¡æœ‰å›¾ç”Ÿå›¾æ˜¾ç¤ºåœ¨ç”»å»Šä¸­\n';
                    resultDiv.className = 'result success';
                }
                
            } catch (error) {
                resultDiv.textContent += `âŒ è°ƒè¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}\n`;
                resultDiv.className = 'result error';
            }
        };

        // æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°æµ‹è¯•
        const clearCacheAndTest = async () => {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.textContent = 'ğŸ§¹ æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°æµ‹è¯•...\n';
            
            try {
                // æ¸…é™¤ç¼“å­˜
                await fetch('/api/share/list?clearCache=true');
                resultDiv.textContent += 'âœ… ç¼“å­˜å·²æ¸…é™¤\n';
                
                // ç­‰å¾…ä¸€ç§’
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // é‡æ–°æµ‹è¯•
                await debugGalleryFilter();
            } catch (error) {
                resultDiv.textContent += `âŒ æ¸…é™¤ç¼“å­˜å¤±è´¥: ${error.message}\n`;
                resultDiv.className = 'result error';
            }
        };

        // æµ‹è¯•ç­›é€‰é€»è¾‘
        const testFilterLogic = () => {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            
            // æ¨¡æ‹Ÿä¸åŒç±»å‹çš„åˆ†äº«æ•°æ®
            const testShares = [
                // æ–‡ç”Ÿå›¾ - åº”è¯¥æ˜¾ç¤ºåœ¨ç”»å»Šä¸­
                { id: 'share_1', style: 'ã‚¸ãƒ–ãƒªé¢¨', originalUrl: null },
                { id: 'share_2', style: 'VTuber', originalUrl: '' },
                { id: 'share_3', style: 'ã‚¦ãƒå¨˜', originalUrl: 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ...' },
                { id: 'share_4', style: 'ã‚«ã‚¹ã‚¿ãƒ ', originalUrl: 'https://placeholder.com/image.jpg' },
                
                // å›¾ç”Ÿå›¾ - ä¸åº”è¯¥æ˜¾ç¤ºåœ¨ç”»å»Šä¸­
                { id: 'share_5', style: 'ã‚¸ãƒ–ãƒªé¢¨', originalUrl: 'https://example.com/original1.jpg' },
                { id: 'share_6', style: 'VTuber', originalUrl: 'https://tempfile.aiquickdraw.com/image.jpg' },
                
                // æ¨¡æ¿æ¨¡å¼ - ä¸åº”è¯¥æ˜¾ç¤ºåœ¨ç”»å»Šä¸­
                { id: 'share_7', style: 'ã‚¸ãƒ–ãƒªé¢¨', originalUrl: 'https://example.com/template-before.jpg' }
            ];
            
            // åº”ç”¨ç­›é€‰é€»è¾‘
            const textToImageShares = testShares.filter(share => {
                const hasValidOriginalUrl = share.originalUrl && 
                    typeof share.originalUrl === 'string' && 
                    share.originalUrl.trim() !== '' &&
                    !share.originalUrl.startsWith('data:image/') &&
                    !share.originalUrl.includes('placeholder.com') &&
                    !share.originalUrl.includes('Text+to+Image') &&
                    !share.originalUrl.includes('base64') &&
                    share.originalUrl.length <= 1000;
                
                return !hasValidOriginalUrl;
            });
            
            resultDiv.textContent = 'ğŸ§ª æµ‹è¯•ç­›é€‰é€»è¾‘ç»“æœ:\n\n';
            resultDiv.textContent += `æ€»å…± ${testShares.length} ä¸ªæµ‹è¯•åˆ†äº«\n`;
            resultDiv.textContent += `æ–‡ç”Ÿå›¾ ${textToImageShares.length} ä¸ªï¼ˆç”»å»Šæ˜¾ç¤ºï¼‰\n`;
            resultDiv.textContent += `å›¾ç”Ÿå›¾/æ¨¡æ¿ ${testShares.length - textToImageShares.length} ä¸ªï¼ˆç”»å»Šéšè—ï¼‰\n\n`;
            
            resultDiv.textContent += 'âœ… ç”»å»Šä¸­æ˜¾ç¤ºçš„åˆ†äº«:\n';
            textToImageShares.forEach(share => {
                resultDiv.textContent += `  - ${share.id}: ${share.style}\n`;
            });
            
            resultDiv.textContent += '\nâŒ ç”»å»Šä¸­éšè—çš„åˆ†äº«:\n';
            testShares.filter(share => !textToImageShares.includes(share)).forEach(share => {
                resultDiv.textContent += `  - ${share.id}: ${share.style} (åŸå› : æœ‰originalUrl)\n`;
            });
            
            // éªŒè¯ç»“æœ
            const expectedTextToImage = ['share_1', 'share_2', 'share_3', 'share_4'];
            const actualTextToImage = textToImageShares.map(s => s.id);
            
            resultDiv.textContent += '\nğŸ¯ éªŒè¯ç»“æœ:\n';
            resultDiv.textContent += `æœŸæœ›çš„æ–‡ç”Ÿå›¾: ${expectedTextToImage.join(', ')}\n`;
            resultDiv.textContent += `å®é™…çš„æ–‡ç”Ÿå›¾: ${actualTextToImage.join(', ')}\n`;
            
            const isCorrect = expectedTextToImage.every(id => actualTextToImage.includes(id)) &&
                             actualTextToImage.every(id => expectedTextToImage.includes(id));
            
            resultDiv.textContent += `\n${isCorrect ? 'âœ… ç­›é€‰é€»è¾‘æ­£ç¡®' : 'âŒ ç­›é€‰é€»è¾‘æœ‰é—®é¢˜'}\n`;
            
            resultDiv.className = isCorrect ? 'result success' : 'result error';
        };
    </script>
</body>
</html> 