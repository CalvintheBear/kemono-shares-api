### 2kawaii 构建与部署策略（Cloudflare Pages / Railway）

本文件梳理项目的构建与部署模式、开关变量、产物目录与注意事项，并给出可直接复制的命令与示例片段。默认推荐“Cloudflare Pages 静态页面 + Pages Functions”混合策略（构建产物在 `out/` 目录）。当前仓库已内置一键脚本，实际以脚本为准。

---

## 1. 构建模式总览

- Cloudflare Pages（静态 + Functions，推荐）
  - 构建：`npm run build:pages:static`
  - 部署：`wrangler pages deploy out --functions=functions`
  - 特点：页面走静态导出（快、稳），API 走 Pages Functions（`functions/`），动态路由通过 `_redirects` 兼容；构建脚本会自动执行 Next 构建/导出、生成站点地图与 Pages 配置文件

- Cloudflare Pages（SSR/动态，next-on-pages）
  - 构建：`npm run build:pages` 或 `npm run build:pages:dynamic`
  - 特点：使用 `@cloudflare/next-on-pages` 将 Next 输出转换为 Pages 识别的结构，保留 SSR 能力；内置路由重叠修复脚本

- Railway（Node 进程运行）
  - 构建：`npm run build:railway`
  - 启动：`npm start`
  - 特点：`output: standalone`，以传统 Node 方式运行 SSR/API

---

## 2. 环境与开关

- Node/NPM：`node >= 20`，`npm >= 10`
- 关键环境变量（构建期生效）
  - `STATIC_EXPORT=true`：Next.js 采用 `export` 模式（静态导出）
  - `RAILWAY=true`：Next.js 采用 `standalone` 输出
  - `CF_PAGES=true`：标识在 Pages 环境（部分脚本使用）

`next.config.ts` 会根据上述开关切换：

```ts
// next.config.ts（节选，与当前实现一致）
output: process.env.STATIC_EXPORT === 'true' 
  ? 'export' 
  : (process.env.RAILWAY === 'true' ? 'standalone' : undefined),

// 静态导出时禁用 i18n（Next export 不支持）
...(process.env.STATIC_EXPORT === 'true' ? {} : {
  i18n: { locales: ['ja'], defaultLocale: 'ja', localeDetection: false }
})

images: {
  remotePatterns: [
    { protocol: 'https', hostname: 'pub-<account>.r2.dev', pathname: '/**' },
    { protocol: 'https', hostname: '2kawaii.com', pathname: '/**' },
  ],
  unoptimized: true,
}
```

---

## 3. Cloudflare Pages：静态 + Functions（推荐）

### 3.1 一键构建与部署

```bash
# 构建（产物在 out/）
npm run build:pages:static

# 部署到 Cloudflare Pages（包含 Functions）
wrangler pages deploy out --project-name=<你的项目> --branch=production --functions=functions

# 或使用内置脚本（会先构建再部署）
npm run deploy:pages:static
```

### 3.2 构建脚本要点

- 脚本：`scripts/build-for-cloudflare-pages-static.js`
  - 设置 `STATIC_EXPORT=true`、`CF_PAGES=true` 并调用 Next 构建/导出
  - 生成 `_redirects`（将 `/share/*` 与 `/en/share/*` 重写为对应的 `*.html?id=:splat`）
  - 生成 `_headers`、`_routes.json`（确保 `/api/*` 进入 Pages Functions）
  - 自动注入关键页面的 `hreflang`，并执行站点地图生成（`next-sitemap`）

示例 `_redirects`（构建脚本会自动写入 `out/_redirects`）：

```text
/share/* /share.html?id=:splat 200
/en/share/* /en/share.html?id=:splat 200
/* /index.html 200
```

示例 `_routes.json`（仅让 `/api/*` 走 Functions）：

```json
{
  "version": 1,
  "include": ["/api/*"],
  "exclude": ["/_next/static/*", "/static/*"]
}
```

### 3.3 静态导出下的动态路由策略

- 分享详情不提供 SSR 动态页面，统一使用 `_redirects` 回退到 `share.html?id=...`（英文同理 `en/share.html?id=...`），由 `src/app/share/page.tsx` 客户端渲染并通过 API 拉取详情
- 代码中保留 `src/app/share/__id/*` 作为占位与 SEO 元信息文件，但不会作为实际动态路由参与导出

---

## 4. Cloudflare Pages：SSR/动态（next-on-pages）

### 4.1 构建

```bash
npm run build:pages
# 或
npm run build:pages:dynamic
```

### 4.2 要点

- 使用 `@cloudflare/next-on-pages` 将 Next 输出转换为 Pages 可识别形态
- 构建后运行 `scripts/fix-routes-overlap.js` 以修复潜在的路由重叠
- 适用于需要保留 SSR 能力的页面，但需关注 Pages 平台的单文件大小限制（25MB）

---

## 5. Railway（standalone）

### 5.1 构建与启动

```bash
npm run build:railway
npm start
```

### 5.2 要点

- `RAILWAY=true` → `next build` 输出 `.next/standalone`
- 以 Node 进程方式运行 SSR/API，部署在 Railway

---

## 6. 产物与目录

- Cloudflare Pages 静态：`out/`（静态文件），`functions/`（Pages Functions）
- Cloudflare Pages 动态：`.vercel/output`（经 next-on-pages 转换后结构）
- Railway：`.next/standalone`（Node 可直接启动）

---

## 7. 常见问题与排错

- Pages 单文件 25MB 限制
  - 方案：减少大体积资源、启用更积极的代码分割、检查 `out/_next` 下大块

- 静态导出后访问 `/share/{id}` 404
  - 检查 `out/_redirects` 是否包含：`/share/* /share.html?id=:splat 200`

- 静态模式下 API 404
  - 确保 `out/_routes.json` 包含：`include: ["/api/*"]`
  - 部署命令携带 `--functions=functions`

- 图片加载异常
  - `next.config.ts` 中 `images.unoptimized=true`，并在 `remotePatterns` 允许 R2/站点域名

---

## 8. CI/CD 建议

- Cloudflare Pages（静态 + Functions）
  - 构建命令：`npm run build:pages:static`
  - 输出目录：`out`
  - Functions 目录：`functions`
  - 环境变量：按需设置 `STATIC_EXPORT=true`，以及运行时所需的 R2/KV/KIE 配置

- Cloudflare Pages（动态）
  - 构建命令：`npm run build:pages`
  - Pages 控台选择 Next.js 框架，或手动配置为使用 `.vercel/output`

---

## 9. 示例片段

### 9.1 package.json（构建相关）

```json
{
  "scripts": {
    "build": "next build",
    "postbuild": "node scripts/build-for-cloudflare-pages-static.js && npx next-sitemap",
    "build:pages": "npm run build && npx @cloudflare/next-on-pages@latest || echo 'skip' && node scripts/fix-routes-overlap.js || echo 'routes-skip' && npx next-sitemap",
    "build:pages:static": "node scripts/build-for-cloudflare-pages-static.js && npx next-sitemap",
    "build:pages:dynamic": "npm run build && npx @cloudflare/next-on-pages@latest && node scripts/fix-routes-overlap.js && npx next-sitemap",
    "build:railway": "node scripts/build-for-railway.js",
    "deploy:pages:static": "node scripts/deploy-cloudflare-pages-static.js"
  }
}
```

### 9.2 `_redirects`（静态导出兼容动态路由）

```text
/share/* /share.html?id=:splat 200
/* /index.html 200
```

### 9.3 `_routes.json`（让 /api/* 落入 Functions）

```json
{
  "version": 1,
  "include": ["/api/*"],
  "exclude": ["/_next/static/*", "/static/*"]
}
```

### 9.4 部署命令（Wrangler）

```bash
wrangler pages deploy out --project-name=<你的项目> --branch=production --functions=functions
# 或
npm run deploy:pages:static
```

---

如需 SSR/动态模式或自托管（Railway）策略，可直接切换对应脚本与环境开关。若页面规模继续增长，建议在 CI 中加入“大文件检测”和“路由重叠校验”步骤，提前发现构建风险。


